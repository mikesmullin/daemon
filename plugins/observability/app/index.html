<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daemon - Multi-Agent Orchestration</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  
  <!-- Alpine.js for reactivity -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- Marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- xterm.js for terminal -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  
  <!-- js-yaml for YAML parsing -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  
  <!-- Application Styles -->
  <link rel="stylesheet" href="/app.css">
  
  <!-- Web Components -->
  <script type="module" src="/components/channel-list.mjs"></script>
  <script type="module" src="/components/thread-view.mjs"></script>
  <script type="module" src="/components/agent-list.mjs"></script>
  <script type="module" src="/components/lucene-filter.mjs"></script>
  <script type="module" src="/components/message-input.mjs"></script>
  <script type="module" src="/components/presence-indicator.mjs"></script>
  <script type="module" src="/components/pty-viewer.mjs"></script>
  
  <!-- Event Bubble Components -->
  <script type="module" src="/components/bubbles/user-bubble.mjs"></script>
  <script type="module" src="/components/bubbles/agent-bubble.mjs"></script>
  <script type="module" src="/components/bubbles/tool-call-bubble.mjs"></script>
  <script type="module" src="/components/bubbles/ask-human-widget.mjs"></script>
  <script type="module" src="/components/bubbles/execute-shell-widget.mjs"></script>
  <script type="module" src="/components/bubbles/thinking-widget.mjs"></script>
  <script type="module" src="/components/bubbles/speak-human-widget.mjs"></script>
  <script type="module" src="/components/bubbles/generic-tool-widget.mjs"></script>
  <script type="module" src="/components/bubbles/editable-bubble.mjs"></script>
  
  <!-- Settings Components -->
  <script type="module" src="/components/template-editor.mjs"></script>
  
  <!-- Application Logic -->
  <script src="/app.js"></script>
</head>
<body>
  <div class="app-container" x-data="app()">
    <!-- Header -->
    <div class="header">
      <div class="hamburger" @click="toggleChannelsSidebar" :title="channelsSidebarOpen ? 'Hide channels' : 'Show channels'">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <div class="breadcrumbs">
        <template x-if="currentPage === 'chat' && currentChannel">
          <span><a href="#" @click.prevent="goHome">Home</a> &gt; Chat &gt; <span x-text="currentChannel"></span></span>
        </template>
        <template x-if="currentPage === 'chat' && !currentChannel">
          <span><a href="#" @click.prevent="goHome">Home</a> &gt; Chat</span>
        </template>
        <template x-if="currentPage === 'settings'">
          <span><a href="#" @click.prevent="goHome">Home</a> &gt; Settings &gt; Agent Templates</span>
        </template>
      </div>
      
      <!-- Connection Status -->
      <div class="connection-status">
        <div class="status-dot" :class="{
          'connected': wsState === 'connected',
          'connecting': wsState === 'connecting',
          'disconnected': wsState === 'disconnected'
        }"></div>
        <span x-text="wsState === 'connected' ? 'Connected' : wsState === 'connecting' ? 'Connecting...' : 'Disconnected'"></span>
      </div>
    </div>
    
    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Channels Sidebar -->
      <div class="channels-sidebar" :class="{ 'collapsed': !channelsSidebarOpen }">
        <channel-list
          :channels="channels"
          :current-channel="currentChannel"
          @channel-select="selectChannel"
          @channel-create="createChannel"
          @channel-mute="muteChannel"
          @settings-open="goToSettings">
        </channel-list>
      </div>
      
      <!-- Chat Area (or Settings) -->
      <div class="chat-area">
        <!-- Chat View -->
        <template x-if="currentPage === 'chat'">
          <div style="display: flex; flex-direction: column; height: 100%;">
            <!-- Filter Bar -->
            <lucene-filter
              :filter="luceneFilter"
              @filter-change="updateFilter"
              @filter-clear="clearFilter">
            </lucene-filter>
            
            <!-- Thread View -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;">
              <!-- Presence Indicator -->
              <presence-indicator
                :working-agents="workingAgents"
                x-show="workingAgents.length > 0">
              </presence-indicator>
              
              <!-- Thread -->
              <thread-view
                x-ref="threadView"
                :events="filteredEvents"
                :filter="luceneFilter"
                :current-channel="currentChannel"
                @event-edit="editEvent"
                @pty-view="viewPty">
              </thread-view>
              
              <!-- PTY Fullscreen Overlay -->
              <template x-if="ptyViewSession">
                <pty-viewer
                  class="fullscreen"
                  :session-id="ptyViewSession"
                  @close="closePty">
                </pty-viewer>
              </template>
            </div>
            
            <!-- Message Input -->
            <message-input
              :current-channel="currentChannel"
              :agents="channelAgents"
              @message-submit="submitMessage"
              @slash-command="handleSlashCommand"
              @template-search="searchTemplates">
            </message-input>
          </div>
        </template>
        
        <!-- Settings View -->
        <template x-if="currentPage === 'settings'">
          <template-editor
            x-ref="templateEditor"
            @template:list-request="handleTemplateListRequest"
            @template:get-request="handleTemplateGetRequest"
            @template:save-request="handleTemplateSaveRequest"
            @template:delete-request="handleTemplateDeleteRequest">
          </template-editor>
        </template>
      </div>
      
      <!-- Agents Sidebar -->
      <div class="agents-sidebar" x-show="currentPage === 'chat'">
        <agent-list
          :agents="channelAgents"
          :current-channel="currentChannel"
          @agent-pause="pauseAgent"
          @agent-resume="resumeAgent"
          @agent-stop="stopAgent"
          @agent-mute="muteAgent"
          @agent-mention="handleAgentMention"
          @pty-view="viewPty"
          @pty-close="closePtyForAgent">
        </agent-list>
      </div>
    </div>
  </div>
</body>
</html>
